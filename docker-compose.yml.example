version: "3"

# Setup Node.js container / MondoDB containers

## Need to confirm subnet settings with Jordin - getting error
#networks :
#  default :
#    ipam :
#      driver: default
#      config:
#     - subnet: 172.10*.19.0/24
services:
  server:
    build: ./server
    container_name: sugoi_portal
    # node runs server app
    command: npm run start
    # use gitlab url to sugoi/custom-proofs/server docker image registry
    image: registry.gitlab.com/garneau-dev/sugoi/custom-proofs/server:1.0.0
    restart: always
    ports:
    ## This needs to change to available web server ports - confirm with Jordin/Jonathan
      - "enter port from wiki:${PORT}"
    # mounts volume for persistant data
    # also mounts volume for node_modules on mac / not sure if needed for server
    volumes:
      - ./server:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - mongo
    links:
      - mongo
    # env file needs to be changed to name of your env file (eg .env)
    env_file:
      - server.env
  mongo:
    container_name: mongo
    restart: always
    image: mongo
    # ports for mongodb is always 27017
    ports:
      - "enter port from wiki:27017"
	  # Creates volume to persist database data with server folder
    volumes:
      - /data/storage/sugoi-custom-proofs.mongodb:/data/db
    # these set mongodb admin and password when first deployed, set in env file
    env_file:
      - mongo.env
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    # starts mongo in -authenticated necessary mode
    command: mongod --auth
